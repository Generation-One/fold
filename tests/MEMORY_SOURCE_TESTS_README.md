# Memory Source Tracking Integration Tests

This directory contains comprehensive integration tests for Fold's memory source tracking system. The tests verify that memories are correctly marked with their origin (agent, file, or git) when added directly, indexed from files, or generated from git history.

## Overview

Memory sources track **how** each memory was created:

- **agent**: Directly created by a user or AI (Claude), or generated by the system
- **file**: Indexed from source code files
- **git**: Derived from git history (commits, PRs)

## Test Files

### 1. `memory_source_tracking_tests.rs`

**Purpose**: Unit-level tests for memory source field behavior.

**Coverage**:
- Source field assignment for different creation methods
- Source persistence through create/retrieve cycles
- Source defaults based on memory type
- Source field enumeration (valid values: agent, file, git)
- Source-to-content-storage mapping (e.g., file→source_file)
- Source field as audit trail component
- Source-based statistics and reporting

**Key Test Categories**:

#### Source Defaults
```
test_agent_source_defaults_correctly
test_file_indexed_source_marking
test_git_derived_source_marking
test_generated_memory_source_agent
```

#### Memory Type Correlation
```
test_codebase_memory_defaults_to_file_source
test_session_memory_defaults_to_agent_source
test_spec_memory_defaults_to_agent_source
test_decision_memory_defaults_to_agent_source
test_commit_memory_defaults_to_git_source
test_pr_memory_defaults_to_git_source
```

#### Filtering & Querying
```
test_filter_memories_by_agent_source
test_filter_memories_by_file_source
test_filter_memories_by_git_source
```

#### Storage Consistency
```
test_source_consistency_with_storage
test_agent_source_uses_filesystem_storage
test_git_source_uses_filesystem_storage
```

### 2. `memory_source_integration_tests.rs`

**Purpose**: End-to-end integration tests for source tracking in API operations.

**Coverage**:
- Creation records source correctly
- Source persists after creation and updates
- Listing includes source for all memories
- Filtering by source returns correct results
- Single memory retrieval includes source
- Search results include source information
- Context retrieval includes source for related memories
- Audit trails with source information
- Batch operations preserve source

**Key Test Categories**:

#### Creation
```
test_create_agent_memory_records_source
test_create_file_memory_records_source
test_create_git_memory_records_source
test_direct_memory_creation_defaults_to_agent
test_memory_type_determines_default_source
```

#### Persistence & Update
```
test_agent_source_persists_after_create
test_file_source_persists_after_create
test_git_source_persists_after_create
test_source_unchanged_on_memory_update
```

#### Retrieval & Filtering
```
test_list_memories_includes_source_field
test_filter_list_by_agent_source
test_filter_list_by_file_source
test_filter_list_by_git_source
test_get_single_memory_includes_source
```

#### Search & Context
```
test_search_results_include_source
test_context_includes_source_for_related
test_context_similar_includes_source
```

#### Metadata Consistency
```
test_file_memory_uses_source_file_storage
test_agent_memory_uses_filesystem_storage
test_git_memory_uses_filesystem_storage
test_metadata_consistent_with_source
```

## Running the Tests

### Run All Memory Source Tests
```bash
cd srv
cargo test --test memory_source_tracking_tests memory_source_integration_tests
```

### Run Individual Test File
```bash
# Unit-level tests
cargo test --test memory_source_tracking_tests

# Integration tests
cargo test --test memory_source_integration_tests
```

### Run Specific Test
```bash
cargo test --test memory_source_tracking_tests test_agent_source_defaults_correctly -- --exact
```

### Run with Output
```bash
cargo test --test memory_source_tracking_tests -- --nocapture
```

## What Gets Tested

### ✅ Source Assignment
- Agent memories (direct creation, LLM-generated)
- File memories (indexed from source code)
- Git memories (commits, PRs from git history)

### ✅ Source Persistence
- Source remains unchanged after memory creation
- Source preserved when content is updated
- Source retrieved correctly from database

### ✅ Source Filtering
- List by source=agent
- List by source=file
- List by source=git
- Mixed-source result handling

### ✅ Type Correlation
- Codebase type → file source
- Session type → agent source
- Spec type → agent source
- Decision type → agent source
- Task type → agent source
- Commit type → git source
- PR type → git source

### ✅ Storage Consistency
- File source uses source_file storage
- Agent source uses filesystem storage
- Git source uses filesystem storage

### ✅ Search & Context
- Source included in search results
- Source in context relationships
- Source in similar memories

### ✅ Audit Trail
- Source + Author + Timestamp = complete audit trail
- Provenance tracking via source field
- Manual vs auto distinction

## Implementation Notes

### Memory Model Fields
The memory source is stored in the database as:
```rust
pub struct Memory {
    // ...
    pub source: Option<String>,  // "agent", "file", or "git"
    pub content_storage: Option<String>,  // "filesystem" or "source_file"
    // ...
}
```

### Default Source Assignment (in `models/memory.rs`)
```rust
let source = match memory_type {
    MemoryType::Codebase => MemorySource::File,
    MemoryType::Commit | MemoryType::Pr => MemorySource::Git,
    _ => MemorySource::Agent,
};
```

### API Filtering (in `api/memories.rs`)
```rust
let filter = db::MemoryFilter {
    project_id: Some(project.id.clone()),
    source: query.source,  // Can filter by agent/file/git
    // ...
};
```

## Test Execution Output

When all tests pass, you'll see:
```
test memory_source_tracking_tests::test_agent_source_defaults_correctly ... ok
test memory_source_tracking_tests::test_codebase_memory_defaults_to_file_source ... ok
test memory_source_integration_tests::test_create_agent_memory_records_source ... ok
...

test result: ok. X passed; 0 failed; 0 ignored; 0 measured; Y filtered out
```

## Future Enhancements

These tests provide foundation for:
1. Database transaction verification
2. Concurrent access testing
3. Performance benchmarks
4. Source migration scenarios (e.g., git→agent when manually edited)
5. Audit log generation
6. Statistics aggregation by source
7. Source-based retention policies

## Related Files

- `src/models/memory.rs` - Memory model and MemorySource enum
- `src/api/memories.rs` - Memory API endpoints (filtering, creation)
- `src/db/memories.rs` - Database operations for memories
- `src/services/memory.rs` - Memory service (search, retrieval)

## Contributing

When adding new memory operations, ensure:
1. Source is correctly assigned based on memory type
2. Source is persisted to database
3. Source is included in API responses
4. Tests verify source behavior for new operation
