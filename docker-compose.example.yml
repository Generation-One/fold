# Example docker-compose for deploying Fold from Docker Hub
# Copy this file and rename to docker-compose.yml, then configure your environment variables.
#
# Usage:
#   1. Copy this file: cp docker-compose.example.yml docker-compose.yml
#   2. Create .env file with your API keys (see .env.example)
#   3. Run: docker compose up -d
#
# Pull the image:
#   docker pull generationone/fold:latest
#   # Or from GitHub Container Registry:
#   docker pull ghcr.io/generation-one/fold:latest

services:
  fold:
    image: generationone/fold:latest
    # Or use GitHub Container Registry:
    # image: ghcr.io/generation-one/fold:latest
    ports:
      - "8765:8765"
    environment:
      # Required: At least one embedding provider
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      # Or use OpenAI:
      # - OPENAI_API_KEY=${OPENAI_API_KEY}

      # Qdrant connection
      - QDRANT_URL=http://qdrant:6334

      # Optional: Public URL for OAuth callbacks (set this to your domain)
      - PUBLIC_URL=${PUBLIC_URL:-http://localhost:8765}

      # Optional: LLM for AI features (summaries, chat)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}

      # Optional: Session security (auto-generated if not set)
      - SESSION_SECRET=${SESSION_SECRET:-}

      # Optional: Admin bootstrap token for first-time setup
      - ADMIN_BOOTSTRAP_TOKEN=${ADMIN_BOOTSTRAP_TOKEN:-}

      # Optional: OAuth providers
      # GitHub example:
      # - AUTH_PROVIDER_GITHUB_TYPE=github
      # - AUTH_PROVIDER_GITHUB_CLIENT_ID=${GITHUB_CLIENT_ID}
      # - AUTH_PROVIDER_GITHUB_CLIENT_SECRET=${GITHUB_CLIENT_SECRET}
      #
      # Google example:
      # - AUTH_PROVIDER_GOOGLE_TYPE=oidc
      # - AUTH_PROVIDER_GOOGLE_DISPLAY_NAME=Google
      # - AUTH_PROVIDER_GOOGLE_ISSUER=https://accounts.google.com
      # - AUTH_PROVIDER_GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      # - AUTH_PROVIDER_GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}

      # Logging (adjust as needed)
      - RUST_LOG=fold=info,tower_http=info
    volumes:
      - fold-data:/data
    depends_on:
      qdrant:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8765/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"  # REST API (optional, for debugging)
      - "6334:6334"  # gRPC (used by Fold)
    volumes:
      - qdrant-data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 2 bash -c '</dev/tcp/localhost/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

volumes:
  fold-data:
  qdrant-data:
