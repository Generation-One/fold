---
id: 7a7a624b-e24d-f3dc-332d-681555c6b69e
title: embeddings.rs
author: system
file_path: src/services/embeddings.rs
language: rust
memory_type: codebase
created_at: 2026-02-03T08:06:18.128619100Z
updated_at: 2026-02-03T08:06:18.128619100Z
---

//! Embedding service with multi-provider fallback.
//!
//! Supports Gemini and OpenAI embedding APIs with automatic fallback
//! when rate limits are hit or providers fail. Falls back to hash-based
//! placeholders when no providers are configured.
//!
//! Providers are loaded from the database with fallback to environment variables
//! for initial seeding.

use std::sync::Arc;
use std::time::Duration;

use reqwest::Client;
use serde::Deserialize;
use serde_json::json;
use tokio::sync::RwLock;
use tokio::time::sleep;
use tracing::{debug, info, warn};

use crate::config::EmbeddingConfig;
use crate::db::{
    list_enabled_embedding_providers, seed_embedding_providers_from_env,
    update_embedding_provider_last_used, DbPool, EmbeddingProviderRow,
};
use crate::error::{Error, Result};

/// Maximum retries per provider before fallback
const MAX_RETRIES: u32 = 2;

/// Delay between retries (doubles each time)
const RETRY_DELAY_MS: u64 = 500;

/// Maximum tex