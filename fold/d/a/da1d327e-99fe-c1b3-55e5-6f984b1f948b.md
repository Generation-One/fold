---
id: da1d327e-99fe-c1b3-55e5-6f984b1f948b
title: llm.rs
author: system
file_path: src/services/llm.rs
language: rust
memory_type: codebase
created_at: 2026-02-03T08:06:51.892663Z
updated_at: 2026-02-03T08:06:51.892663Z
---

//! LLM service with multi-provider fallback.
//!
//! Supports Gemini, Anthropic (Claude), OpenRouter, and OpenAI with automatic fallback
//! when rate limits are hit or providers fail.
//!
//! Providers are loaded from the database with fallback to environment variables
//! for initial seeding.

use std::sync::Arc;
use std::time::Duration;

use reqwest::Client;
use serde::{Deserialize, Serialize};
use serde_json::{json, Value};
use tokio::sync::RwLock;
use tokio::time::sleep;
use tracing::{debug, info, warn};

use crate::config::LlmConfig;
use crate::db::{
    list_enabled_llm_providers, seed_claudecode_provider_async, seed_llm_providers_from_env,
    update_llm_provider_last_used, DbPool, LlmProviderRow,
};
use crate::error::{Error, Result};
use crate::models::{CodeSummary, CommitInfo, Memory, SuggestedLink};
use super::ClaudeCodeService;

/// Maximum retries per provider before fallback
const MAX_RETRIES: u32 = 2;

/// Delay between retries (doubles eac