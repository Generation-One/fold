---
id: d8ec7fd9-432d-0a0d-d512-636cf7cd4793
title: token_auth.rs
author: system
file_path: src/middleware/token_auth.rs
language: rust
memory_type: codebase
created_at: 2026-02-03T08:05:47.300097800Z
updated_at: 2026-02-03T08:05:47.300097800Z
---

//! API token authentication middleware.
//!
//! Validates Bearer tokens from the Authorization header for programmatic API access.
//! Used by MCP clients, CLI tools, webhooks, and other automated integrations.
//!
//! Token format: `fold_{prefix}_{random}` where:
//! - `fold_` is a fixed prefix for identification
//! - `{prefix}` is 8 chars used for database lookup (stored as `token_prefix`)
//! - `{random}` is the remaining secret (hashed and stored as `token_hash`)
//!
//! # Security Model
//!
//! - Tokens are looked up by prefix (fast index lookup)
//! - Full token is verified against stored hash (timing-safe comparison)
//! - Each token can be scoped to specific projects
//! - Tokens can be revoked or expired

use axum::{
    body::Body,
    extract::{Path, Request, State},
    http::header::AUTHORIZATION,
    middleware::Next,
    response::Response,
};
use sha2::{Digest, Sha256};
use sqlx::FromRow;

use crate::{error::Error, AppState};

/// Authenti