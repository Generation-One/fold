---
id: 6f685121-7e9b-3a69-7698-869bafd53dc8
title: mod.rs
author: system
file_path: src/middleware/mod.rs
language: rust
memory_type: codebase
created_at: 2026-02-03T08:05:43.852111Z
updated_at: 2026-02-03T08:05:43.852111Z
---

//! Middleware for Fold.
//!
//! Provides authentication and authorization middleware:
//! - `token_auth` - API token validation for programmatic access (MCP, CLI, webhooks)
//! - `session_auth` - Session/cookie validation for web UI access

mod session_auth;
mod token_auth;

pub use session_auth::{
    require_session, SessionUser, SESSION_COOKIE_NAME,
};
pub use token_auth::{
    require_token,
    AuthContext,
};

use axum::{
    body::Body,
    extract::{Request, State},
    middleware::Next,
    response::Response,
};
use axum_extra::extract::CookieJar;
use crate::{error::Error, AppState};

/// User context that supports both session and token authentication.
///
/// This can be created from either a SessionUser (from session middleware)
/// or from an AuthContext (from token middleware), allowing endpoints to
/// accept either authentication method.
#[derive(Clone, Debug)]
pub struct AuthUser {
    pub user_id: String,
    pub email: Option<Strin